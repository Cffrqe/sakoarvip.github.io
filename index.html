<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebPhys Engine 3.0</title>
    <style>
        :root {
            --bg-dark: #1e1e1e;
            --bg-panel: #252526;
            --bg-header: #333333;
            --accent: #007acc;
            --accent-hover: #0098ff;
            --text-main: #cccccc;
            --text-highlight: #ffffff;
            --border: #3e3e42;
            --input-bg: #3c3c3c;
            --success: #4ec9b0;
            --x-axis: #ff5555;
            --y-axis: #55ff55;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 13px;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* LAYOUT */
        #toolbar {
            height: 45px;
            background-color: var(--bg-header);
            display: flex;
            align-items: center;
            padding: 0 15px;
            border-bottom: 1px solid var(--border);
            gap: 15px;
            user-select: none;
        }

        #main-area {
            display: flex;
            flex: 1;
            height: calc(100vh - 45px);
        }

        .panel {
            background-color: var(--bg-panel);
            display: flex;
            flex-direction: column;
        }

        #hierarchy { width: 220px; border-right: 1px solid var(--border); }
        #scene-container { flex: 1; position: relative; background: #111; overflow: hidden; }
        #inspector { width: 300px; border-left: 1px solid var(--border); overflow-y: auto; }

        /* UI ELEMENTS */
        .panel-header {
            padding: 8px 12px;
            font-weight: 600;
            background: #2d2d30;
            border-bottom: 1px solid var(--border);
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
        }

        button {
            background: #444;
            color: var(--text-highlight);
            border: 1px solid transparent;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
        }
        button:hover { background: #555; }
        button.active { background: var(--accent); }
        button.danger { background: #d93025; }

        input, select, textarea {
            background: var(--input-bg);
            border: 1px solid var(--border);
            color: white;
            padding: 4px 6px;
            border-radius: 2px;
            width: 100%;
            box-sizing: border-box;
            font-family: monospace;
        }
        
        .row { display: flex; align-items: center; margin-bottom: 8px; gap: 8px; }
        .row label { width: 70px; flex-shrink: 0; color: #aaa; }
        
        /* HIERARCHY LIST */
        .list-item {
            padding: 4px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        .list-item:hover { background: #2a2d2e; }
        .list-item.selected { background: #37373d; color: var(--accent); border-left: 2px solid var(--accent); }

        /* TOOL GROUPS */
        .tool-group { display: flex; gap: 2px; background: #222; padding: 2px; border-radius: 4px; }
        .separator { width: 1px; height: 20px; background: var(--border); margin: 0 5px; }

        /* SCRIPT EDITOR */
        .code-editor {
            background: #1e1e1e;
            border: 1px solid var(--border);
            color: #d4d4d4;
            font-family: 'Consolas', monospace;
            min-height: 150px;
            resize: vertical;
            font-size: 12px;
            line-height: 1.4;
            tab-size: 4;
        }

        /* CANVAS OVERLAY (GIZMOS) */
        #gizmo-layer {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none; /* Let clicks pass through unless on a handle */
            width: 100%;
            height: 100%;
        }

        .hidden { display: none !important; }
        
        /* CONSOLE */
        #console-log {
            font-family: monospace;
            font-size: 11px;
            color: #aaa;
            padding: 10px;
            border-top: 1px solid var(--border);
            max-height: 100px;
            overflow-y: auto;
            background: #1e1e1e;
        }
    </style>
</head>
<body>

    <!-- TOOLBAR -->
    <div id="toolbar">
        <div style="font-weight:bold; color:var(--accent);">WebPhys 3.0</div>
        
        <div class="separator"></div>

        <!-- Play Controls -->
        <div class="tool-group">
            <button id="btn-play" onclick="setMode('play')">▶ Play</button>
            <button id="btn-edit" class="active" onclick="setMode('edit')">❚❚ Edit</button>
        </div>

        <div class="separator"></div>

        <!-- Transform Tools -->
        <div class="tool-group">
            <button id="tool-move" class="active" onclick="setTool('move')">✚ Move</button>
            <button id="tool-scale" onclick="setTool('scale')">⤢ Scale</button>
        </div>

        <div class="separator"></div>

        <!-- Create -->
        <div class="tool-group">
            <button onclick="Spawner.create('box')">+ Box</button>
            <button onclick="Spawner.create('circle')">+ Circle</button>
            <button onclick="Spawner.create('car')">+ Car</button>
        </div>

        <div class="separator"></div>

        <!-- Settings -->
        <div style="display:flex; align-items:center; gap:5px;">
            <label>FPS:</label>
            <select id="fps-select" style="width:70px" onchange="EngineCore.setFPS(this.value)">
                <option value="30">30</option>
                <option value="60" selected>60</option>
                <option value="120">120</option>
                <option value="0">Max</option>
            </select>
        </div>

        <div style="flex:1"></div>
        <button class="danger" onclick="EngineCore.clearScene()">Clear Scene</button>
    </div>

    <!-- MAIN WORKSPACE -->
    <div id="main-area">
        
        <!-- LEFT: HIERARCHY -->
        <div id="hierarchy" class="panel">
            <div class="panel-header">Hierarchy</div>
            <div id="hierarchy-list" style="flex:1; overflow-y:auto;">
                <!-- List items injected here -->
            </div>
            <div id="console-log">Console Ready...</div>
        </div>

        <!-- CENTER: SCENE -->
        <div id="scene-container">
            <!-- Matter.js Canvas injected here -->
            <canvas id="gizmo-canvas"></canvas> <!-- Overlay for tools -->
        </div>

        <!-- RIGHT: INSPECTOR -->
        <div id="inspector" class="panel">
            <div class="panel-header">Inspector</div>
            
            <div id="inspector-empty" style="padding:20px; color:#666; text-align:center;">
                No object selected
            </div>

            <div id="inspector-content" class="hidden" style="padding:15px;">
                
                <!-- Identity -->
                <div class="row">
                    <label>Name</label>
                    <input type="text" id="insp-name">
                </div>
                <div class="row">
                    <label>ID</label>
                    <input type="text" id="insp-id" disabled style="color:#666">
                </div>

                <hr style="border:0; border-top:1px solid #444; margin:15px 0;">

                <!-- Transform -->
                <div style="font-weight:bold; margin-bottom:10px;">Transform</div>
                <div class="row">
                    <label>Pos X</label>
                    <input type="number" id="insp-x">
                </div>
                <div class="row">
                    <label>Pos Y</label>
                    <input type="number" id="insp-y">
                </div>
                <div class="row">
                    <label>Angle</label>
                    <input type="number" id="insp-angle">
                </div>

                <hr style="border:0; border-top:1px solid #444; margin:15px 0;">

                <!-- Physics Material -->
                <div style="font-weight:bold; margin-bottom:10px;">Physics</div>
                <div class="row">
                    <label>Static</label>
                    <input type="checkbox" id="insp-static" style="width:auto;">
                </div>
                <div class="row">
                    <label>Friction</label>
                    <input type="number" step="0.1" id="insp-friction">
                </div>
                <div class="row">
                    <label>Bounce</label>
                    <input type="number" step="0.1" id="insp-restitution">
                </div>

                <hr style="border:0; border-top:1px solid #444; margin:15px 0;">

                <!-- Visuals -->
                <div style="font-weight:bold; margin-bottom:10px;">Visuals</div>
                <div class="row">
                    <label>Color</label>
                    <input type="color" id="insp-color" style="height:30px;">
                </div>
                <div class="row">
                    <label>Texture URL</label>
                    <input type="text" id="insp-texture" placeholder="http://...">
                </div>

                <hr style="border:0; border-top:1px solid #444; margin:15px 0;">

                <!-- Scripting -->
                <div style="font-weight:bold; margin-bottom:10px; color:var(--success)">Script (Update Loop)</div>
                <div style="font-size:10px; color:#888; margin-bottom:5px;">
                    Available: <code>body</code>, <code>engine</code>, <code>input</code>
                </div>
                <textarea id="insp-script" class="code-editor" placeholder="// body.position.x += 1;"></textarea>
                <button onclick="Inspector.applyScript()" style="width:100%; margin-top:5px;">Apply Script</button>

                <hr style="border:0; border-top:1px solid #444; margin:15px 0;">
                
                <button class="danger" style="width:100%" onclick="Spawner.deleteSelected()">Delete Object</button>
            </div>
        </div>
    </div>

    <!-- LIBRARIES -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.18.0/matter.min.js"></script>

    <!-- ENGINE LOGIC -->
    <script>
        // --- 1. CORE SETUP ---
        const Engine = Matter.Engine,
              Render = Matter.Render,
              Runner = Matter.Runner,
              Bodies = Matter.Bodies,
              Composite = Matter.Composite,
              Events = Matter.Events,
              Body = Matter.Body,
              Vector = Matter.Vector,
              Mouse = Matter.Mouse;

        const container = document.getElementById('scene-container');
        const gizmoCanvas = document.getElementById('gizmo-canvas');
        
        // Setup Matter Engine
        const engine = Engine.create();
        const world = engine.world;

        // Render Setup
        const render = Render.create({
            element: container,
            engine: engine,
            options: {
                width: container.clientWidth,
                height: container.clientHeight,
                wireframes: false,
                background: '#1a1a1a',
                pixelRatio: 1
            }
        });

        // Resize Handling
        function handleResize() {
            render.canvas.width = container.clientWidth;
            render.canvas.height = container.clientHeight;
            gizmoCanvas.width = container.clientWidth;
            gizmoCanvas.height = container.clientHeight;
        }
        window.addEventListener('resize', handleResize);
        handleResize();

        // Mouse Input for Raycasting
        const mouse = Mouse.create(render.canvas);
        
        // State
        const AppState = {
            mode: 'edit', // 'edit' or 'play'
            tool: 'move', // 'move', 'scale'
            selectedBody: null,
            targetFPS: 60,
            frameCount: 0,
            input: {
                keys: {}
            }
        };

        // --- 2. GAME LOOP (Custom for FPS Control) ---
        const EngineCore = {
            lastTime: 0,
            accumulatedTime: 0,
            
            setFPS: function(val) {
                AppState.targetFPS = parseInt(val);
                console.log("FPS Set to:", AppState.targetFPS);
            },

            clearScene: function() {
                Composite.clear(world);
                EngineCore.createFloor();
                AppState.selectedBody = null;
                Inspector.updateUI();
                Hierarchy.render();
            },

            createFloor: function() {
                const floor = Bodies.rectangle(400, 600, 2000, 60, { 
                    isStatic: true, 
                    label: "Ground",
                    render: { fillStyle: '#444' } 
                });
                Composite.add(world, floor);
            },

            loop: function(timestamp) {
                requestAnimationFrame(EngineCore.loop);

                const deltaTime = timestamp - EngineCore.lastTime;
                
                // FPS Throttling
                const interval = AppState.targetFPS > 0 ? (1000 / AppState.targetFPS) : 0;
                
                if (deltaTime > interval) {
                    EngineCore.lastTime = timestamp - (deltaTime % interval);
                    
                    // LOGIC STEP
                    if (AppState.mode === 'play') {
                        Engine.update(engine, 1000 / 60); // Physics step fixed at 60hz for stability
                        ScriptSystem.update();
                    }

                    // RENDER STEP
                    Render.world(render);
                    Gizmos.draw(); // Draw Editor Tools
                }
            }
        };

        // --- 3. INPUT SYSTEM & GIZMOS ---
        
        const Gizmos = {
            dragActive: false,
            dragMode: null, // 'x', 'y', 'scale'
            dragStartPos: { x: 0, y: 0 },
            initialObjState: null, // {x, y, scale}

            draw: function() {
                const ctx = gizmoCanvas.getContext('2d');
                ctx.clearRect(0, 0, gizmoCanvas.width, gizmoCanvas.height);

                if (!AppState.selectedBody) return;
                
                const b = AppState.selectedBody;
                const pos = b.position;

                ctx.lineWidth = 2;

                // Draw Selection Box
                ctx.strokeStyle = '#007acc';
                ctx.beginPath();
                ctx.moveTo(b.bounds.min.x, b.bounds.min.y);
                ctx.lineTo(b.bounds.max.x, b.bounds.min.y);
                ctx.lineTo(b.bounds.max.x, b.bounds.max.y);
                ctx.lineTo(b.bounds.min.x, b.bounds.max.y);
                ctx.closePath();
                ctx.stroke();

                if (AppState.mode !== 'edit') return;

                // MOVE TOOL
                if (AppState.tool === 'move') {
                    // X Axis (Red)
                    ctx.strokeStyle = '#ff5555';
                    ctx.fillStyle = '#ff5555';
                    ctx.beginPath();
                    ctx.moveTo(pos.x, pos.y);
                    ctx.lineTo(pos.x + 60, pos.y);
                    ctx.stroke();
                    // Arrowhead
                    ctx.beginPath();
                    ctx.moveTo(pos.x + 60, pos.y - 5);
                    ctx.lineTo(pos.x + 70, pos.y);
                    ctx.lineTo(pos.x + 60, pos.y + 5);
                    ctx.fill();

                    // Y Axis (Green)
                    ctx.strokeStyle = '#55ff55';
                    ctx.fillStyle = '#55ff55';
                    ctx.beginPath();
                    ctx.moveTo(pos.x, pos.y);
                    ctx.lineTo(pos.x, pos.y - 60); // Up
                    ctx.stroke();
                    // Arrowhead
                    ctx.beginPath();
                    ctx.moveTo(pos.x - 5, pos.y - 60);
                    ctx.lineTo(pos.x, pos.y - 70);
                    ctx.lineTo(pos.x + 5, pos.y - 60);
                    ctx.fill();
                } 
                // SCALE TOOL
                else if (AppState.tool === 'scale') {
                    ctx.fillStyle = '#ffffff';
                    // Draw a box at corners
                    const size = 10;
                    ctx.fillRect(b.bounds.max.x - size/2, b.bounds.max.y - size/2, size, size);
                }
            },

            checkHit: function(mx, my) {
                if (!AppState.selectedBody || AppState.mode !== 'edit') return null;
                const pos = AppState.selectedBody.position;
                
                if (AppState.tool === 'move') {
                    // Check X Arrow
                    if (mx > pos.x && mx < pos.x + 70 && Math.abs(my - pos.y) < 10) return 'moveX';
                    // Check Y Arrow
                    if (my < pos.y && my > pos.y - 70 && Math.abs(mx - pos.x) < 10) return 'moveY';
                }
                if (AppState.tool === 'scale') {
                    const b = AppState.selectedBody.bounds;
                    const dist = Math.hypot(mx - b.max.x, my - b.max.y);
                    if (dist < 15) return 'scale';
                }
                return null;
            }
        };

        // Input Event Listeners
        gizmoCanvas.addEventListener('mousedown', e => {
            const rect = gizmoCanvas.getBoundingClientRect();
            const mx = e.clientX - rect.left;
            const my = e.clientY - rect.top;

            // 1. Check Gizmo Hit
            const gizmoHit = Gizmos.checkHit(mx, my);
            if (gizmoHit) {
                Gizmos.dragActive = true;
                Gizmos.dragMode = gizmoHit;
                Gizmos.dragStartPos = { x: mx, y: my };
                Gizmos.initialObjState = { ...AppState.selectedBody.position, bounds: AppState.selectedBody.bounds };
                return;
            }

            // 2. Check Object Hit (Raycast)
            const bodies = Composite.allBodies(world);
            const clicked = Matter.Query.point(bodies, { x: mx, y: my });
            
            if (clicked.length > 0) {
                Inspector.select(clicked[0]);
            } else {
                Inspector.deselect();
            }
        });

        window.addEventListener('mousemove', e => {
            const rect = gizmoCanvas.getBoundingClientRect();
            const mx = e.clientX - rect.left;
            const my = e.clientY - rect.top;

            if (Gizmos.dragActive && AppState.selectedBody) {
                const dx = mx - Gizmos.dragStartPos.x;
                const dy = my - Gizmos.dragStartPos.y;

                if (Gizmos.dragMode === 'moveX') {
                    Body.setPosition(AppState.selectedBody, { 
                        x: Gizmos.initialObjState.x + dx, 
                        y: AppState.selectedBody.position.y 
                    });
                } else if (Gizmos.dragMode === 'moveY') {
                    Body.setPosition(AppState.selectedBody, { 
                        x: AppState.selectedBody.position.x, 
                        y: Gizmos.initialObjState.y + dy 
                    });
                } else if (Gizmos.dragMode === 'scale') {
                    // Simple uniform scaling factor based on drag
                    const scaleFactor = 1 + (dx / 100);
                    // Reset scale logic is complex in Matter, simple approximation:
                    // Only apply delta scaling if moving slowly, usually better to reconstruct body, 
                    // but for this demo, we use Body.scale (cumulative)
                    // A safe way:
                    if(Math.abs(dx) > 1 || Math.abs(dy) > 1) {
                         const s = 1 + (dx * 0.005);
                         Body.scale(AppState.selectedBody, s, s);
                         Gizmos.dragStartPos = {x: mx, y: my}; // Reset to avoid exponential growth
                    }
                }
                Inspector.updateUI(); // Live update inspector
            }
        });

        window.addEventListener('mouseup', () => {
            Gizmos.dragActive = false;
        });
        
        // Key Tracking for Scripts
        window.addEventListener('keydown', e => AppState.input.keys[e.key] = true);
        window.addEventListener('keyup', e => AppState.input.keys[e.key] = false);


        // --- 4. INSPECTOR & HIERARCHY ---

        const Inspector = {
            ui: {
                name: document.getElementById('insp-name'),
                id: document.getElementById('insp-id'),
                x: document.getElementById('insp-x'),
                y: document.getElementById('insp-y'),
                angle: document.getElementById('insp-angle'),
                static: document.getElementById('insp-static'),
                friction: document.getElementById('insp-friction'),
                restitution: document.getElementById('insp-restitution'),
                color: document.getElementById('insp-color'),
                texture: document.getElementById('insp-texture'),
                script: document.getElementById('insp-script'),
                content: document.getElementById('inspector-content'),
                empty: document.getElementById('inspector-empty')
            },

            select: function(body) {
                AppState.selectedBody = body;
                this.ui.content.classList.remove('hidden');
                this.ui.empty.classList.add('hidden');
                
                // Init custom props if missing
                if(!body.custom) body.custom = { script: "", textureUrl: "" };
                
                this.updateUI();
                Hierarchy.highlight(body.id);
            },

            deselect: function() {
                AppState.selectedBody = null;
                this.ui.content.classList.add('hidden');
                this.ui.empty.classList.remove('hidden');
                Hierarchy.render();
            },

            updateUI: function() {
                if (!AppState.selectedBody) return;
                const b = AppState.selectedBody;
                
                // Prevent updating if focused to allow typing
                if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') return;

                this.ui.name.value = b.label;
                this.ui.id.value = b.id;
                this.ui.x.value = Math.round(b.position.x);
                this.ui.y.value = Math.round(b.position.y);
                this.ui.angle.value = b.angle.toFixed(2);
                this.ui.static.checked = b.isStatic;
                this.ui.friction.value = b.friction;
                this.ui.restitution.value = b.restitution;
                this.ui.color.value = b.render.fillStyle;
                this.ui.texture.value = b.custom.textureUrl || "";
                this.ui.script.value = b.custom.script || "";
            },

            applyChanges: function() {
                if (!AppState.selectedBody) return;
                const b = AppState.selectedBody;
                
                b.label = this.ui.name.value;
                Body.setPosition(b, { x: parseFloat(this.ui.x.value), y: parseFloat(this.ui.y.value) });
                Body.setAngle(b, parseFloat(this.ui.angle.value));
                Body.setStatic(b, this.ui.static.checked);
                b.friction = parseFloat(this.ui.friction.value);
                b.restitution = parseFloat(this.ui.restitution.value);
                b.render.fillStyle = this.ui.color.value;

                // Texture Logic
                const texUrl = this.ui.texture.value;
                if (texUrl && texUrl !== b.custom.textureUrl) {
                    b.custom.textureUrl = texUrl;
                    b.render.sprite.texture = texUrl;
                    // Reset sprite scale slightly to make it visible
                    b.render.sprite.xScale = 1; 
                    b.render.sprite.yScale = 1; 
                } else if (!texUrl) {
                    b.render.sprite.texture = null;
                }

                Hierarchy.render(); // Update name in list
            },
            
            applyScript: function() {
                if (AppState.selectedBody) {
                    AppState.selectedBody.custom.script = this.ui.script.value;
                    logConsole("Script updated for " + AppState.selectedBody.label);
                }
            }
        };

        // Bind Inputs
        ['change', 'input'].forEach(evt => {
            Object.values(Inspector.ui).forEach(el => {
                if(el && el.tagName !== 'DIV') el.addEventListener(evt, () => Inspector.applyChanges());
            });
        });

        const Hierarchy = {
            list: document.getElementById('hierarchy-list'),
            
            render: function() {
                this.list.innerHTML = '';
                Composite.allBodies(world).forEach(b => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    if (AppState.selectedBody === b) div.classList.add('selected');
                    div.innerText = b.label || `Body ${b.id}`;
                    div.onclick = () => Inspector.select(b);
                    this.list.appendChild(div);
                });
            },

            highlight: function(id) {
                // Quick style update without full rerender
                Array.from(this.list.children).forEach(child => child.classList.remove('selected'));
                this.render(); // lazy full render to ensure sync
            }
        };

        // --- 5. SCRIPTING SYSTEM ---
        
        const ScriptSystem = {
            update: function() {
                Composite.allBodies(world).forEach(b => {
                    if (b.custom && b.custom.script && b.custom.script.trim() !== "") {
                        try {
                            // Create a safe-ish function
                            // We pass: body, engine, input
                            const func = new Function('body', 'engine', 'input', b.custom.script);
                            func(b, engine, AppState.input);
                        } catch (e) {
                            // Rate limit errors to avoid console flood
                            if (Math.random() < 0.01) logConsole(`Script Error (${b.label}): ${e.message}`);
                        }
                    }
                });
            }
        };

        function logConsole(msg) {
            const c = document.getElementById('console-log');
            const d = document.createElement('div');
            d.innerText = `> ${msg}`;
            c.prepend(d);
        }

        // --- 6. UTILS & HELPERS ---

        const Spawner = {
            create: function(type) {
                const x = container.clientWidth / 2;
                const y = container.clientHeight / 2;
                let b;

                if (type === 'box') {
                    b = Bodies.rectangle(x, y, 50, 50, { label: 'Box', render: { fillStyle: '#007acc' } });
                } else if (type === 'circle') {
                    b = Bodies.circle(x, y, 25, { label: 'Circle', render: { fillStyle: '#e06c75' } });
                } else if (type === 'car') {
                    // Simple prefab
                    const chassis = Bodies.rectangle(x, y, 100, 30, { label: 'Car Chassis' });
                    const w1 = Bodies.circle(x - 35, y + 20, 15, { friction: 0.8, label: 'Wheel L' });
                    const w2 = Bodies.circle(x + 35, y + 20, 15, { friction: 0.8, label: 'Wheel R' });
                    const ax1 = Matter.Constraint.create({ bodyA: chassis, bodyB: w1, pointA: {x:-35, y:20}, stiffness: 0.5 });
                    const ax2 = Matter.Constraint.create({ bodyA: chassis, bodyB: w2, pointA: {x:35, y:20}, stiffness: 0.5 });
                    Composite.add(world, [chassis, w1, w2, ax1, ax2]);
                    Hierarchy.render();
                    return;
                }

                if (b) {
                    b.custom = { script: "", textureUrl: "" };
                    Composite.add(world, b);
                    Inspector.select(b);
                    Hierarchy.render();
                }
            },
            
            deleteSelected: function() {
                if(AppState.selectedBody) {
                    Composite.remove(world, AppState.selectedBody);
                    Inspector.deselect();
                }
            }
        };

        function setMode(mode) {
            AppState.mode = mode;
            document.getElementById('btn-play').classList.toggle('active', mode === 'play');
            document.getElementById('btn-edit').classList.toggle('active', mode === 'edit');
            
            // In Edit Mode, remove gravity temporarily or freeze? 
            // Matter.js is hard to 'pause' perfectly without stopping the runner.
            // Our custom loop handles the update logic stop.
            
            if (mode === 'edit') {
                // Optional: Reset scene physics if desired, but for now we just pause.
            }
        }

        function setTool(tool) {
            AppState.tool = tool;
            document.getElementById('tool-move').classList.toggle('active', tool === 'move');
            document.getElementById('tool-scale').classList.toggle('active', tool === 'scale');
        }

        // --- INIT ---
        EngineCore.createFloor();
        EngineCore.loop(0);

    </script>
</body>
</html>

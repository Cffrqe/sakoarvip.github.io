<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sakoar Sandbox</title>
    <style>
        :root {
            --bg: #1a1a1a;
            --panel: #2d2d2d;
            --accent: #e67e22; /* Sakoar Orange */
            --text: #ffffff;
            --btn: #3d3d3d;
        }

        body {
            margin: 0;
            overflow: hidden;
            background: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none;
        }

        /* UI LAYOUT */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .hud-panel {
            pointer-events: auto;
            background: rgba(45, 45, 45, 0.9);
            backdrop-filter: blur(5px);
            padding: 10px;
            border: 1px solid #444;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* TOP BAR: TOOLS & SETTINGS */
        #top-bar {
            margin: 10px;
            border-radius: 8px;
            justify-content: space-between;
        }

        /* LEFT BAR: SPAWN MENU */
        #left-bar {
            position: absolute;
            left: 10px;
            top: 70px;
            bottom: 10px;
            width: 140px;
            flex-direction: column;
            border-radius: 8px;
            overflow-y: auto;
            align-items: stretch;
        }

        /* CONTROLS */
        button {
            background: var(--btn);
            border: 1px solid #555;
            color: white;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            font-weight: bold;
            transition: all 0.1s;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button:hover { background: #555; transform: translateX(2px); }
        button:active { transform: scale(0.98); }
        
        button.active-tool {
            background: var(--accent);
            border-color: var(--accent);
            color: black;
        }

        .category-header {
            font-size: 10px;
            text-transform: uppercase;
            color: #aaa;
            margin-top: 10px;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type=range] { width: 100px; }

        /* SCENE */
        #scene {
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle at center, #222 0%, #111 100%);
            cursor: crosshair;
        }
        
        /* INSTRUCTIONS */
        #controls-hint {
            position: absolute;
            bottom: 20px;
            right: 20px;
            color: rgba(255,255,255,0.3);
            text-align: right;
            font-size: 12px;
        }
    </style>
</head>
<body>

    <!-- CANVAS -->
    <div id="scene"></div>

    <!-- UI OVERLAY -->
    <div id="ui-layer">
        
        <!-- TOP: TOOLS -->
        <div id="top-bar" class="hud-panel">
            <div style="display:flex; gap:5px; align-items:center;">
                <span style="font-weight:800; color:var(--accent); margin-right:10px;">SAKOAR SANDBOX</span>
                
                <div style="width:1px; height:20px; background:#555;"></div>

                <!-- Tools -->
                <button class="active-tool" onclick="Tools.set('drag')" id="btn-drag">‚úã Drag</button>
                <button onclick="Tools.set('gun')" id="btn-gun">üî´ Gun</button>
                <button onclick="Tools.set('delete')" id="btn-delete">‚ùå Delete</button>
                <button onclick="Tools.set('explode')" id="btn-explode">üí£ Boom</button>
            </div>

            <div style="display:flex; gap:15px; align-items:center;">
                <div>
                    <div style="font-size:10px; color:#aaa;">Time Scale</div>
                    <input type="range" min="0.1" max="2" step="0.1" value="1" oninput="Sandbox.setTimeScale(this.value)">
                </div>
                <button onclick="Sandbox.clear()" style="background:#c0392b;">üóë Clear All</button>
            </div>
        </div>

        <!-- LEFT: SPAWN MENU -->
        <div id="left-bar" class="hud-panel">
            
            <div class="category-header">Characters</div>
            <button onclick="Spawner.ragdoll()">üèÉ Ragdoll</button>
            <button onclick="Spawner.boxMan()">ü§ñ Box Bot</button>

            <div class="category-header">Vehicles</div>
            <button onclick="Spawner.car()">üèéÔ∏è Sport Car</button>
            <button onclick="Spawner.truck()">üöö Truck</button>

            <div class="category-header">Props</div>
            <button onclick="Spawner.crate()">üì¶ Crate</button>
            <button onclick="Spawner.plank()">üìè Plank</button>
            <button onclick="Spawner.tnt()">üß® TNT Block</button>
            
            <div class="category-header">Weapons</div>
            <button onclick="Spawner.weapon('ak')">üî´ AK-47 Item</button>

        </div>

        <div id="controls-hint">
            <b>Controls:</b><br>
            Left Click: Use Tool<br>
            Right Click: Drag Objects<br>
            Arrow Keys: Drive Vehicle
        </div>

    </div>

    <!-- PHYSICS LIBRARY -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>

    <script>
        const Engine = Matter.Engine,
              Render = Matter.Render,
              Runner = Matter.Runner,
              Bodies = Matter.Bodies,
              Composite = Matter.Composite,
              Composites = Matter.Composites,
              Constraint = Matter.Constraint,
              Mouse = Matter.Mouse,
              MouseConstraint = Matter.MouseConstraint,
              Events = Matter.Events,
              Body = Matter.Body,
              Vector = Matter.Vector;

        // --- SANDBOX CORE ---
        const Sandbox = {
            engine: Engine.create(),
            runner: Runner.create(),
            render: null,
            width: window.innerWidth,
            height: window.innerHeight,
            activeCar: null, // The car currently controlled by keys

            init: function() {
                // Setup Render
                const container = document.getElementById('scene');
                this.render = Render.create({
                    element: container,
                    engine: this.engine,
                    options: {
                        width: this.width,
                        height: this.height,
                        wireframes: false,
                        background: 'transparent',
                        showAngleIndicator: true,
                        showCollisions: false
                    }
                });

                // Boundaries
                this.createBoundaries();

                // Mouse Handling
                const mouse = Mouse.create(this.render.canvas);
                
                // Allow right-click dragging regardless of tool
                const mouseConstraint = MouseConstraint.create(this.engine, {
                    mouse: mouse,
                    constraint: { stiffness: 0.1, render: { visible: false } }
                });
                // Custom mouse filtering logic in Tools object
                Composite.add(this.engine.world, mouseConstraint);
                this.mouseConstraint = mouseConstraint;

                // Event Listeners
                window.addEventListener('resize', () => {
                    this.width = window.innerWidth;
                    this.height = window.innerHeight;
                    this.render.canvas.width = this.width;
                    this.render.canvas.height = this.height;
                    this.createBoundaries(); // Rebuild floor
                });

                // Key Input (Driving)
                window.addEventListener('keydown', (e) => this.handleKeys(e, true));
                window.addEventListener('keyup', (e) => this.handleKeys(e, false));

                // Tool Input
                Events.on(mouseConstraint, 'mousedown', (e) => Tools.onMouseDown(e));

                // Start
                Render.run(this.render);
                Runner.run(this.runner, this.engine);
            },

            createBoundaries: function() {
                Composite.remove(this.engine.world, this.walls || []);
                const t = 100; // thickness
                this.walls = [
                    Bodies.rectangle(this.width/2, this.height + t/2 - 20, this.width*2, t, { isStatic: true, render: { fillStyle: '#444' } }), // Floor
                    Bodies.rectangle(-t/2, this.height/2, t, this.height*2, { isStatic: true }), // Left
                    Bodies.rectangle(this.width + t/2, this.height/2, t, this.height*2, { isStatic: true }) // Right
                ];
                Composite.add(this.engine.world, this.walls);
            },

            handleKeys: function(e, isDown) {
                if(!this.activeCar) return;
                
                const speed = 0.3;
                if(e.key === 'ArrowRight' || e.key === 'd') {
                    this.activeCar.gas = isDown ? speed : 0;
                }
                if(e.key === 'ArrowLeft' || e.key === 'a') {
                    this.activeCar.gas = isDown ? -speed : 0;
                }
            },

            updateCars: function() {
                // Apply torque to active car wheels
                if(this.activeCar) {
                    const car = this.activeCar;
                    if(car.gas !== 0) {
                        Body.setAngularVelocity(car.w1, car.gas);
                        Body.setAngularVelocity(car.w2, car.gas);
                    }
                }
            },

            clear: function() {
                Composite.clear(this.engine.world);
                this.createBoundaries();
                Composite.add(this.engine.world, this.mouseConstraint);
                this.activeCar = null;
            },

            setTimeScale: function(val) {
                this.engine.timing.timeScale = parseFloat(val);
            }
        };

        // --- TOOLS ---
        const Tools = {
            current: 'drag', // drag, gun, delete, explode
            
            set: function(name) {
                this.current = name;
                document.querySelectorAll('.active-tool').forEach(el => el.classList.remove('active-tool'));
                document.getElementById('btn-'+name).classList.add('active-tool');

                // Enable/Disable mouse constraint based on tool
                // We actually keep mouse constraint for Right Click, 
                // but Left Click behavior changes.
            },

            onMouseDown: function(e) {
                const mousePos = e.mouse.position;
                
                // Only act on left click (button 0)
                if(e.mouse.button !== 0) return;

                if(this.current === 'delete') {
                    const bodies = Composite.allBodies(Sandbox.engine.world);
                    const clicked = Matter.Query.point(bodies, mousePos);
                    // Don't delete walls
                    const target = clicked.find(b => !b.isStatic);
                    if(target) {
                        // We need to find if it belongs to a composite (like a car or ragdoll)
                        // A simple way is to remove the body, but for ragdolls, it leaves constraints floating.
                        // For a sandbox, just removing the body is usually fine and funny.
                        Composite.remove(Sandbox.engine.world, target);
                        createExplosionParticle(target.position.x, target.position.y, 5, '#fff');
                    }
                }

                if(this.current === 'gun') {
                    Spawner.bullet(mousePos.x, mousePos.y);
                    // Shake screen slightly
                    const canvas = Sandbox.render.canvas;
                    canvas.style.transform = `translate(${Math.random()*4-2}px, ${Math.random()*4-2}px)`;
                    setTimeout(()=>canvas.style.transform='none', 50);
                }

                if(this.current === 'explode') {
                    Spawner.explosion(mousePos.x, mousePos.y, 150, 0.5);
                }

                // Drag is handled natively by MouseConstraint if no other logic interferes
                if(this.current !== 'drag') {
                    // Temporarily disable drag for the click frame if using a tool
                    // (Handled by checking mouse button in logic usually, but Matter's constraint grabs aggressively)
                }
            }
        };

        // --- SPAWNER (PREFABS) ---
        const Spawner = {
            
            crate: function() {
                const b = Bodies.rectangle(400, 200, 60, 60, { 
                    render: { fillStyle: '#8e44ad' },
                    restitution: 0.5
                });
                Composite.add(Sandbox.engine.world, b);
            },

            plank: function() {
                const b = Bodies.rectangle(400, 200, 200, 20, { 
                    render: { fillStyle: '#d35400' },
                    density: 0.002
                });
                Composite.add(Sandbox.engine.world, b);
            },

            tnt: function() {
                const b = Bodies.rectangle(400, 200, 40, 40, { 
                    render: { fillStyle: '#c0392b', strokeStyle: '#fff', lineWidth: 2 },
                    label: 'TNT'
                });
                // Add click listener logic later or use tool to explode
                Composite.add(Sandbox.engine.world, b);
            },

            bullet: function(tx, ty) {
                // Spawn at screen center bottom or just offset from mouse?
                // Let's spawn from a theoretical "camera" position (center screen) toward mouse
                // Or if we want "God Mode" shooting, spawn at mouse and shoot forward?
                
                // Let's do: Spawn exactly where clicked, but add impulse
                // Actually better: Raycast style. 
                // Sandbox style: Spawn a small fast ball at mouse location traveling in direction of movement?
                // No, usually you click to shoot AT that spot. 
                // Let's spawn bullet at Top Left moving toward mouse.
                
                const sx = 100, sy = 100; // source
                const angle = Math.atan2(ty - sy, tx - sx);
                const speed = 30;
                
                const b = Bodies.circle(sx, sy, 5, { 
                    render: { fillStyle: 'yellow' },
                    density: 0.01,
                    frictionAir: 0
                });
                Body.setVelocity(b, {
                    x: Math.cos(angle) * speed,
                    y: Math.sin(angle) * speed
                });
                Composite.add(Sandbox.engine.world, b);
                
                // Cleanup bullet after 2 seconds
                setTimeout(() => Composite.remove(Sandbox.engine.world, b), 2000);
            },

            explosion: function(x, y, radius, force) {
                const bodies = Composite.allBodies(Sandbox.engine.world);
                bodies.forEach(b => {
                    if(b.isStatic) return;
                    const d = Vector.sub(b.position, {x:x, y:y});
                    const dist = Vector.magnitude(d);
                    if(dist < radius) {
                        const normal = Vector.normalise(d);
                        const appliedForce = Vector.mult(normal, force * (1 - dist/radius) * b.mass);
                        Body.applyForce(b, b.position, appliedForce);
                    }
                });
                
                // Visual FX
                createExplosionParticle(x, y, 20, 'orange');
            },

            ragdoll: function() {
                const x = 400, y = 200;
                const group = Body.nextGroup(true);
                const head = Bodies.circle(x, y-25, 15, { collisionFilter: { group: group }, render: { fillStyle: '#f1c40f' } });
                const chest = Bodies.rectangle(x, y, 30, 40, { collisionFilter: { group: group }, render: { fillStyle: '#e74c3c' } });
                
                // Limbs
                const rArm = Bodies.rectangle(x+20, y-10, 10, 30, { collisionFilter: { group: group }, render: { fillStyle: '#e67e22' } });
                const lArm = Bodies.rectangle(x-20, y-10, 10, 30, { collisionFilter: { group: group }, render: { fillStyle: '#e67e22' } });
                const rLeg = Bodies.rectangle(x+10, y+40, 10, 40, { collisionFilter: { group: group }, render: { fillStyle: '#2980b9' } });
                const lLeg = Bodies.rectangle(x-10, y+40, 10, 40, { collisionFilter: { group: group }, render: { fillStyle: '#2980b9' } });

                // Constraints (Joints)
                const neck = Constraint.create({ bodyA: head, bodyB: chest, pointA: {x:0, y:15}, pointB: {x:0, y:-20}, stiffness: 0.5 });
                const cRArm = Constraint.create({ bodyA: chest, bodyB: rArm, pointA: {x:15, y:-15}, pointB: {x:0, y:-12}, stiffness: 0.5 });
                const cLArm = Constraint.create({ bodyA: chest, bodyB: lArm, pointA: {x:-15, y:-15}, pointB: {x:0, y:-12}, stiffness: 0.5 });
                const cRLeg = Constraint.create({ bodyA: chest, bodyB: rLeg, pointA: {x:10, y:20}, pointB: {x:0, y:-18}, stiffness: 0.5 });
                const cLLeg = Constraint.create({ bodyA: chest, bodyB: lLeg, pointA: {x:-10, y:20}, pointB: {x:0, y:-18}, stiffness: 0.5 });

                Composite.add(Sandbox.engine.world, [head, chest, rArm, lArm, rLeg, lLeg, neck, cRArm, cLArm, cRLeg, cLLeg]);
            },

            boxMan: function() {
                // A simpler, sturdier NPC
                const x = 500, y = 200;
                const box = Bodies.rectangle(x, y, 40, 80, { 
                    render: { fillStyle: '#2ecc71' },
                    chamfer: { radius: 10 }
                });
                Composite.add(Sandbox.engine.world, box);
            },

            car: function() {
                const x = 300, y = 300;
                const group = Body.nextGroup(true);
                
                const chassis = Bodies.rectangle(x, y, 140, 30, { 
                    collisionFilter: { group: group },
                    render: { fillStyle: '#c0392b' },
                    chamfer: { radius: 5 },
                    density: 0.004
                });
                
                const w1 = Bodies.circle(x-40, y+20, 18, { 
                    collisionFilter: { group: group },
                    friction: 0.8,
                    render: { fillStyle: '#222' },
                    density: 0.01
                });
                
                const w2 = Bodies.circle(x+40, y+20, 18, { 
                    collisionFilter: { group: group },
                    friction: 0.8,
                    render: { fillStyle: '#222' },
                    density: 0.01
                });

                const ax1 = Constraint.create({
                    bodyA: chassis, bodyB: w1,
                    pointA: {x:-40, y:15}, stiffness: 0.2, length: 0, damping: 0.1
                });

                const ax2 = Constraint.create({
                    bodyA: chassis, bodyB: w2,
                    pointA: {x:40, y:15}, stiffness: 0.2, length: 0, damping: 0.1
                });

                Composite.add(Sandbox.engine.world, [chassis, w1, w2, ax1, ax2]);

                // Set as active car for controls
                Sandbox.activeCar = { w1: w1, w2: w2, gas: 0 };
            },

            truck: function() {
                const x = 400, y = 300;
                const group = Body.nextGroup(true);
                
                const cab = Bodies.rectangle(x, y, 60, 50, { collisionFilter: { group: group }, render: { fillStyle: '#34495e' } });
                const bed = Bodies.rectangle(x-60, y+10, 100, 30, { collisionFilter: { group: group }, render: { fillStyle: '#95a5a6' } });
                Body.setDensity(cab, 0.01);

                // Attach bed to cab
                const join = Constraint.create({ bodyA: cab, bodyB: bed, pointA: {x:-30, y:10}, pointB: {x:50, y:0}, stiffness: 1 });

                const w1 = Bodies.circle(x+15, y+25, 20, { collisionFilter: { group: group }, friction: 0.9, render: { fillStyle: '#222' } });
                const w2 = Bodies.circle(x-90, y+25, 20, { collisionFilter: { group: group }, friction: 0.9, render: { fillStyle: '#222' } });

                const ax1 = Constraint.create({ bodyA: cab, bodyB: w1, pointA: {x:15, y:25}, stiffness: 0.2, length:0 });
                const ax2 = Constraint.create({ bodyA: bed, bodyB: w2, pointA: {x:-30, y:15}, stiffness: 0.2, length:0 });

                Composite.add(Sandbox.engine.world, [cab, bed, w1, w2, join, ax1, ax2]);
                Sandbox.activeCar = { w1: w1, w2: w2, gas: 0 };
            },

            weapon: function(type) {
                // Spawns a physical gun object
                // In a true sandbox, this would be holdable. 
                // Here we just make a gun-shaped object that looks cool.
                const x = 500, y = 200;
                const stock = Bodies.rectangle(x-20, y+5, 10, 20, { render: {fillStyle: '#8e44ad'} });
                const barrel = Bodies.rectangle(x, y, 40, 8, { render: {fillStyle: '#333'} });
                const gun = Body.create({
                    parts: [stock, barrel],
                    render: { fillStyle: '#333' }
                });
                Composite.add(Sandbox.engine.world, gun);
            }
        };

        // --- VISUAL FX ---
        function createExplosionParticle(x, y, size, color) {
            // A visual only particle using DOM or Canvas overlay would be best, 
            // but we can spawn a short-lived physical body that doesn't collide
            const p = Bodies.circle(x, y, size, { 
                isStatic: true,
                render: { fillStyle: color, opacity: 0.8 },
                collisionFilter: { mask: 0 } // No collision
            });
            Composite.add(Sandbox.engine.world, p);
            
            let scale = 1;
            const grow = setInterval(() => {
                scale += 0.2;
                Body.scale(p, 1.1, 1.1);
                p.render.opacity -= 0.1;
                if(p.render.opacity <= 0) {
                    clearInterval(grow);
                    Composite.remove(Sandbox.engine.world, p);
                }
            }, 50);
        }

        // --- LOOP HOOKS ---
        Events.on(Sandbox.engine, 'beforeUpdate', () => {
            Sandbox.updateCars();
        });

        // Init
        Sandbox.init();

    </script>
</body>
</html>
